<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Monastery360 v17 тАФ Final</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  :root {
    --font-sans: "Inter", "Segoe UI", system-ui, Arial;
    --radius: 12px;
    /* Light Mode */
    --bg-primary: #f3f6fb;
    --bg-secondary: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --border-color: #e2e8f0;
    --accent-primary: #0077b6;
    --accent-secondary: #e0f2fe;
    --shadow-color: rgba(0,0,0,0.1);
  }

  body.dark-mode {
    /* Dark Mode */
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --text-primary: #c9d1d9;
    --text-secondary: #8b949e;
    --border-color: #30363d;
    --accent-primary: #0096c7;
    --accent-secondary: #0c2d48;
    --shadow-color: rgba(0,0,0,0.4);
  }

  body {
    margin: 0;
    font-family: var(--font-sans);
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  #map {
    position: fixed;
    left: 0; right: 0; top: 56px; bottom: 0;
    z-index: 0;
    background-color: var(--bg-primary);
  }
  .header {
    position: fixed; left: 0; right: 0; top: 0; height: 56px;
    background: var(--bg-secondary);
    display: flex; align-items: center;
    box-shadow: 0 2px 8px var(--shadow-color);
    border-bottom: 1px solid var(--border-color);
    z-index: 1200; padding: 0 16px; gap: 12px;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  .brand { font-weight: 700; font-size: 18px; color: var(--text-primary); }
  #sidebar {
    position: fixed; left: 12px; top: 68px; width: 350px; bottom: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 14px;
    box-shadow: 0 6px 20px var(--shadow-color);
    border: 1px solid var(--border-color);
    overflow: auto;
    z-index: 1200;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  .sectionTitle { font-weight: 700; margin: 16px 0 8px 0; font-size: 14px; color: var(--text-primary); }

  .controls-container { margin-left: auto; display: flex; align-items: center; gap: 16px; }
  .lang-switcher, .theme-switcher { display: flex; gap: 4px; background: var(--bg-primary); border-radius: 8px; padding: 4px; border: 1px solid var(--border-color); }
  .lang-btn, .theme-btn { padding: 6px 10px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; color: var(--text-secondary); }
  .lang-btn.active, .theme-btn.active { background: var(--accent-primary); color: white; }
  .monastery-card {
    border-radius: var(--radius); padding: 12px; background: var(--bg-primary);
    border: 1px solid var(--border-color); margin-bottom: 10px; cursor: pointer; transition: all .2s ease;
  }
  .monastery-card:hover { border-color: var(--accent-primary); }
  .monastery-name { font-weight: 700; }
  .attractions-list { display: none; margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--border-color); }
  .attraction-item { font-size: 14px; color: var(--text-secondary); padding: 8px; border-radius: 8px; cursor: pointer; }
  .attraction-item:hover { background-color: var(--accent-secondary); color: var(--accent-primary); }
  .infoBox {
    position: fixed; right: 18px; bottom: 18px; z-index: 1300; width: 360px;
    background: var(--bg-secondary); border: 1px solid var(--border-color);
    padding: 14px; border-radius: var(--radius); box-shadow: 0 12px 30px var(--shadow-color);
    font-size: 14px; display: none;
  }
  .infoBox.visible { display: block; }
  .map-pin { width: 32px; height: 32px; border-radius: 50% 50% 50% 0; border: 2px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: rotate(-45deg); display: flex; justify-content: center; align-items: center; }
  .map-pin-icon { font-size: 18px; transform: rotate(45deg); }
  .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 16px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  /* Ensure markers receive clicks */
  .leaflet-marker-icon, .custom-div-icon, .map-pin { pointer-events: auto; cursor: pointer; }
</style>
</head>
<body>

  <div class="header">
    <div class="brand" data-translate-key="title">Monastery360</div>
    <div class="controls-container">
      <div class="lang-switcher">
        <button id="lang-en" class="lang-btn" onclick="setLanguage('en')">English</button>
        <button id="lang-ne" class="lang-btn" onclick="setLanguage('ne')">рдиреЗрдкрд╛рд▓реА</button>
        <button id="lang-bo" class="lang-btn" onclick="setLanguage('bo')">р╜Цр╜╝р╜Ср╝Лр╜жр╛Рр╜С</button>
      </div>
      <div class="theme-switcher">
        <button id="theme-light" class="theme-btn" onclick="setTheme('light')">тШАя╕П</button>
        <button id="theme-dark" class="theme-btn" onclick="setTheme('dark')">ЁЯМЩ</button>
      </div>
    </div>
  </div>

  <div id="sidebar">
    <div class="sectionTitle" data-translate-key="monasteries_title">Monasteries</div>
    <div id="monasteryList"></div>
  </div>

  <div id="map"></div>

  <div class="infoBox" id="infoBox">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div id="infoTitle" style="font-weight:700" data-translate-key="estimates_title">Travel Estimates</div>
        <button id="closeInfo" data-translate-key="close_btn">Close</button>
    </div>
    <div id="infoContent"></div>
  </div>

<script>
/* ------------------------------
   1. DATA & TRANSLATIONS
   ------------------------------ */
const translations = {
    en: { title: "Monastery360", monasteries_title: "Monasteries", estimates_title: "Travel Estimates", close_btn: "Close", route_from: "Route from", fare_details: "Taxi Route Details", road_dist: "Road Distance", est_time: "Est. Time", est_fare: "Est. Fare", route_error: "<b>Route Not Found.</b><br>A road path could not be found for this area." },
    ne: { title: "рдореЛрдирд╛рд╕реНрдЯреНрд░реАрейремреж", monasteries_title: "рдЧреБрдореНрдмрд╛рд╣рд░реВ", estimates_title: "рдпрд╛рддреНрд░рд╛ рдЕрдиреБрдорд╛рди", close_btn: "рдмрдиреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН", route_from: "рдмрд╛рдЯ рдорд╛рд░реНрдЧ", fare_details: "рдЯреНрдпрд╛рдХреНрд╕реА рдорд╛рд░реНрдЧ рд╡рд┐рд╡рд░рдг", road_dist: "рд╕рдбрдХ рджреВрд░реА", est_time: "рдЕрдиреБрдорд╛рдирд┐рдд рд╕рдордп", est_fare: "рдЕрдиреБрдорд╛рдирд┐рдд рднрд╛рдбрд╛", route_error: "<b>рдорд╛рд░реНрдЧ рдлреЗрд▓рд╛ рдкрд░реЗрдиред</b><br>рдпрд╕ рдХреНрд╖реЗрддреНрд░рдорд╛ рдирдХреНрд╕рд╛ рдбрд╛рдЯрд╛ рдЕрдкреВрд░реНрдг рднрдПрдХреЛ рдХрд╛рд░рдгрд▓реЗ рд╕рдбрдХ рдорд╛рд░реНрдЧ рдлреЗрд▓рд╛ рдкрд╛рд░реНрди рд╕рдХрд┐рдПрдиред" },
    bo: { title: "р╜Ср╜Вр╜╝р╜Ур╝Лр╜Фр╝Лр╝гр╝жр╝а", monasteries_title: "р╜Ср╜Вр╜╝р╜Ур╝Лр╜Фр╝Лр╜Ър╜╝р╝Н", estimates_title: "р╜ар╜Вр╛▓р╜┤р╜гр╝Лр╜Цр╜Юр╜┤р╜Ср╝Лр╜Ър╜╝р╜Ср╝Лр╜Ср╜Фр╜В", close_btn: "р╜Бр╝Лр╜вр╛Тр╛▒р╜В", route_from: "р╜Ур╜жр╝Н", fare_details: "р╜Шр╜╝р╝Лр╜Кр╜ар╜▓р╝Лр╜гр╜Шр╝Лр╜Вр╛▒р╜▓р╝Л рк╡рк┐ркЧркдр╝Н", road_dist: "р╜гр╜Шр╝Лр╜Рр╜В", est_time: "р╜Ър╜╝р╜Ср╝Лр╜Ср╜Фр╜Вр╝Лр╜Ср╜┤р╜жр╝Лр╜Ър╜╝р╜Ср╝Н", est_fare: "р╜Ър╜╝р╜Ср╝Лр╜Ср╜Фр╜Вр╝Лр╜Вр╛│р╝Лр╜Жр╝Н", route_error: "<b>р╜гр╜Шр╝Лр╜Шр╝Лр╜вр╛Щр╜║р╜Ср╝Н</b><br>р╜жр╝Лр╜Бр╛▓р╜ар╜▓р╝Лр╜Вр╜Ур╜жр╝Лр╜Ър╜Ср╝Лр╜Шр╝Лр╜Ър╜Др╝Лр╜Цр╜ар╜▓р╝Лр╜Ср╜Цр╜Др╝Лр╜Вр╜▓р╜жр╝Лр╜гр╜Шр╝Лр╜Юр╜▓р╜Вр╝Лр╜вр╛Щр╜║р╜Ср╝Лр╜Шр╝Лр╜жр╜╝р╜Др╝Лр╝Н" }
};
const DATA = {
  monasteries: [
    { id:'rumtek', name: {en:'Rumtek Monastery', ne:'рд░реБрдордЯреЗрдХ рдЧреБрдореНрдмрд╛', bo:'р╜вр╜┤р╜Шр╝Лр╜Рр╜║р╜Вр╝Лр╜Ср╜Вр╜╝р╜Ур╝Лр╜Фр╝Л'}, icon: 'ЁЯПп', coords:[27.3302, 88.6130], color:'#d90429', attractions: [
        {id: 'rumtek_1', name: {en:'J.L. Nehru Botanical Garden', ne:'рдЬреЗ.рдПрд▓. рдиреЗрд╣рд░реВ рд╡рдирд╕реНрдкрддрд┐ рдЙрджреНрдпрд╛рди', bo:'р╜в botanical р╜жр╛Рр╛▒р╜║р╜Ср╝Лр╜Ър╜гр╝Н'}, icon: 'ЁЯМ│', coords: [27.3261, 88.6185]},
        {id: 'rumtek_2', name: {en:'Namgyal Institute of Tibetology', ne:'рдирд╛рдордЧреНрдпрд╛рд▓ рддрд┐рдмреНрдмрддреЛрд▓реЛрдЬреА рд╕рдВрд╕реНрдерд╛рди', bo:'Namgyal р╜Цр╜╝р╜Ср╝Лр╜вр╜▓р╜Вр╝Лр╜Фр╜ар╜▓р╝Лр╜жр╛│р╜╝р╜Цр╝Лр╜Вр╜Йр╜║р╜вр╝Лр╜Бр╜Др╝Лр╝Н'}, icon: 'ЁЯУЪ', coords: [27.3248, 88.6069]},
        {id: 'rumtek_3', name: {en:'Do Drul Chorten Stupa', ne:'рджреЛ рджреНрд░реБрд▓ рдЪреЛрд░реНрддреЗрди рд╕реНрддреБрдк', bo:'р╜Шр╜Ср╜╝р╝Лр╜Вр╛▓р╜┤р╜гр╝Лр╜Шр╜Жр╜╝р╜Ср╝Лр╜вр╛Яр╜║р╜Ур╝Н'}, icon: 'тШ╕я╕П', coords: [27.3174, 88.6121]}
    ]},
    { id:'ranka', name: {en:'Ranka (Lingdum) Monastery', ne:'рд░рд╛рдЩреНрдХрд╛ (рд▓рд┐рдЩреНрджрдо) рдЧреБрдореНрдмрд╛', bo:'р╜Вр╛│р╜▓р╜Др╝Лр╜Ср╜┤р╜Шр╝Лр╜Ср╜Вр╜╝р╜Ур╝Лр╜Фр╝Л'}, icon: 'ЁЯПп', coords:[27.3386, 88.6724], color:'#0077b6', attractions: [
        {id: 'ranka_1', name: {en:'Banjhakri Falls & Energy Park', ne:'рдмрдирдЭрд╛рдХреНрд░реА рдЭрд░рдирд╛ рд░ рдКрд░реНрдЬрд╛ рдкрд╛рд░реНрдХ', bo:'р╜Цр╜Ур╝Лр╜Зр╜Вр╝Лр╜вр╜▓р╝Лр╜вр╛жр╜Цр╝Лр╜Жр╜┤р╝Н'}, icon: 'ЁЯПЮя╕П', coords: [27.3202, 88.6411]},
        // REPLACED Lingdum View Point with Tashi View Point for better routing data
        {id: 'ranka_2', name: {en:'Tashi View Point', ne:'рддрд╛рд╢реА рднреНрдпреВ рдкреЛрдЗрдиреНрдЯ', bo:'р╜Цр╜Ар╛▓р╝Лр╜др╜▓р╜жр╝Лр╜гр╛Яр╝Л╨│╨╗╤П╨┤╨║╨╕р╝Н'}, icon: 'тЫ░я╕П', coords: [27.3595, 88.6215]},
        {id: 'ranka_3', name: {en:'Ganesh Tok', ne:'рдЧрдгреЗрд╢ рдЯреЛрдХ', bo:'р╜ВркгрлЗр╜др╝Лр╜Пр╜╝р╜В'}, icon: 'ЁЯХЙя╕П', coords: [27.3503, 88.6256]}
    ]},
    { id:'pemayangtse', name: {en:'Pemayangtse Monastery', ne:'рдкреЗрдорд╛рдпрдЩреНрддреНрд╕реЗ рдЧреБрдореНрдмрд╛', bo:'р╜Фр╜Ср╛ир╝Лр╜бр╜Др╝Лр╜вр╛йр╜║р╝Лр╜Ср╜Вр╜╝р╜Ур╝Лр╜Фр╝Л'}, icon: 'ЁЯПп', coords:[27.3054, 88.2393], color:'#028090', attractions: [
        {id: 'pema_1', name: {en:'Rabdentse Ruins', ne:'рд░рд╛рдмреНрджреЗрдиреНрддреНрд╕реЗ рднрдЧреНрдирд╛рд╡рд╢реЗрд╖', bo:'р╜вр╜Цр╝Лр╜Цр╜вр╛Яр╜Ур╝Лр╜вр╛йр╜║р╝Л р░╢р░┐р░зр░┐р░▓р╕Лр╕▓р╕Бр╝Н'}, icon: 'ЁЯПЫя╕П', coords: [27.2989, 88.2351]},
        {id: 'pema_2', name: {en:'Pelling Skywalk', ne:'рдкреЗрд▓рд┐рдЩ рд╕реНрдХрд╛рдИрд╡рд╛рдХ', bo:'Skywalk  рдЖрдХрд╛рд╢р░ор░╛р░░р▒Нр░Чр╝Н'}, icon: 'ЁЯМЙ', coords: [27.2885, 88.2391]},
        {id: 'pema_3', name: {en:'Khecheopalri Lake', ne:'рдЦреЗрдЪреЗрдУрдкрд▓реНрд░реА рддрд╛рд▓', bo:'р╜Шр╜Бр╜ар╝Лр╜жр╛др╛▒р╜╝р╜Ср╝Лр╜Ср╜Фр╜гр╝Лр╜вр╜▓р╝Лр╜Шр╜Ър╜╝р╝Н'}, icon: 'ЁЯТз', coords: [27.3604, 88.2249]}
    ]}
  ]
};
const modeProfiles = { taxi: { profile: 'driving', baseCost: 40, perKm: 18, color: '#ff6d00' } };

/* ------------------------------
   2. MAP SETUP & GLOBAL STATE
   ------------------------------ */
let currentLanguage = 'en';
let currentRouteLayer = null;
let openMonasteries = new Set();
// Registry to map attraction IDs to their markers and parents
const attractionRegistry = {};
const sikkimBounds = L.latLngBounds(L.latLng(27.0, 88.0), L.latLng(28.2, 89.0));
const map = L.map('map', { maxBounds: sikkimBounds, maxBoundsViscosity: 1.0, minZoom: 8 });
// Ensure no generic map click handlers are active
map.off('click');
map.fitBounds(sikkimBounds);
const monasteryLayer = L.layerGroup().addTo(map);
const attractionLayer = L.layerGroup().addTo(map);

/* ------------------------------
   3. CORE LOGIC
   ------------------------------ */
async function getRouteData(startCoords, endCoords, profile) {
    const url = `https://router.project-osrm.org/route/v1/${profile}/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson`;
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        const data = await response.json();
        if (data.code === 'Ok' && data.routes.length > 0) return data.routes[0];
    } catch (error) { console.error("Route fetching failed:", error); }
    return null;
}
function drawRoute(geoJsonGeometry, color) {
    if (currentRouteLayer) map.removeLayer(currentRouteLayer);
    currentRouteLayer = L.geoJSON(geoJsonGeometry, { style: { color, weight: 5, opacity: 0.75 } }).addTo(map);
    map.fitBounds(currentRouteLayer.getBounds().pad(0.2));
}
async function calculateAndShowRoute(startCoords, endCoords, title) {
    const box = document.getElementById('infoBox'), infoContent = document.getElementById('infoContent');
    document.getElementById('infoTitle').innerText = title;
    infoContent.innerHTML = '<div class="loader"></div>';
    box.classList.add('visible');
    const route = await getRouteData(startCoords, endCoords, modeProfiles.taxi.profile);
    const lang = translations[currentLanguage];
    if (route) {
        const distanceKm = (route.distance / 1000), timeMin = Math.round(route.duration / 60), cost = Math.round(modeProfiles.taxi.baseCost + modeProfiles.taxi.perKm * distanceKm);
        infoContent.innerHTML = `<div style="padding: 8px;"><p><strong>ЁЯЪХ ${lang.fare_details}</strong></p><p>${lang.road_dist}: <strong>${distanceKm.toFixed(2)} km</strong></p><p>${lang.est_time}: <strong>~${timeMin} minutes</strong></p><p>${lang.est_fare}: <strong>тВ╣${cost}</strong></p></div>`;
        drawRoute(route.geometry, modeProfiles.taxi.color);
    } else { infoContent.innerHTML = lang.route_error; }
}

// Shared helper: open fare popup for a monastery->attraction and draw route
async function openFarePopup(monasteryObj, attractionObj) {
    // Try to use user's current location as pickup; fallback to monastery coords
    const end = attractionObj.coords;
    const userPickup = await (async () => {
        if (!navigator.geolocation) return null;
        try {
            const pos = await new Promise((resolve, reject) => {
                const id = navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            });
            return [pos.coords.latitude, pos.coords.longitude];
        } catch (_) { return null; }
    })();
    const start = userPickup || monasteryObj.coords;
    const popup = L.popup({ closeButton: true })
      .setLatLng(end)
      .setContent('<div style="min-width:220px;">Calculating fare...</div>')
      .openOn(map);
    const route = await getRouteData(start, end, modeProfiles.taxi.profile);
    const lang = translations[currentLanguage];
    if (route) {
        const distanceKm = (route.distance / 1000);
        const timeMin = Math.round(route.duration / 60);
        const cost = Math.round(modeProfiles.taxi.baseCost + modeProfiles.taxi.perKm * distanceKm);
        const bookUrl = `/book-ride?pickupLat=${encodeURIComponent(start[0])}&pickupLng=${encodeURIComponent(start[1])}&destLat=${encodeURIComponent(end[0])}&destLng=${encodeURIComponent(end[1])}&distanceKm=${encodeURIComponent(distanceKm.toFixed(2))}&timeMin=${encodeURIComponent(timeMin)}&fare=${encodeURIComponent(cost)}&from=${encodeURIComponent(userPickup ? 'Current Location' : monasteryObj.name.en)}&to=${encodeURIComponent(attractionObj.name.en)}`;
        const content = `
          <div style=\"font-family:Inter,system-ui,Arial;\"> 
            <div style=\"font-weight:700;margin-bottom:6px;\">${lang.estimates_title}</div>
            <div style=\"font-size:14px;color:#475569;\"> 
              <div>${lang.road_dist}: <strong>${distanceKm.toFixed(2)} km</strong></div>
              <div>${lang.est_time}: <strong>~${timeMin} minutes</strong></div>
              <div>${lang.est_fare}: <strong>₹${cost}</strong></div>
            </div>
            ${userPickup ? '<div style=\\"font-size:12px;color:#64748b;margin-top:4px;\\">Pickup: Your current location</div>' : '<div style=\\"font-size:12px;color:#64748b;margin-top:4px;\\">Pickup: Monastery location (location permission denied)</div>'}
            <div style=\"margin-top:10px;\"> 
              <a href=\"${bookUrl}\" style=\"display:inline-block;background:#ff6d00;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600;\">Book my ride</a>
            </div>
          </div>
        `;
        popup.setContent(content);
        drawRoute(route.geometry, modeProfiles.taxi.color);
    } else {
        popup.setContent(`<div style=\"font-family:Inter,system-ui,Arial;max-width:240px;\">${lang.route_error}</div>`);
    }
}

/* ------------------------------
   4. UI, THEME, LANGUAGE MANAGEMENT
   ------------------------------ */
function setLanguage(lang) {
    currentLanguage = lang;
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        const key = el.dataset.translateKey;
        if (translations[lang][key]) el.innerText = translations[lang][key];
    });
    initializeSidebarAndMarkers();
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`lang-${lang}`).classList.add('active');
}

function setTheme(theme) {
    document.body.className = theme === 'dark' ? 'dark-mode' : '';
    localStorage.setItem('theme', theme);
    document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`theme-${theme}`).classList.add('active');
    updateMapTiles(theme);
}

// TILE FIX: Using more reliable Stadia (Stamen) tiles for both light and dark modes
function updateMapTiles(theme) {
    const lightTileUrl = 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png';
    const darkTileUrl = 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png';
    const attribution = '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>';
    
    if (window.tileLayer) map.removeLayer(window.tileLayer);
    
    window.tileLayer = L.tileLayer(theme === 'dark' ? darkTileUrl : lightTileUrl, { attribution, maxZoom: 20 }).addTo(map);
}

/* ------------------------------
   5. INITIALIZATION & EVENT HANDLING
   ------------------------------ */
function initializeSidebarAndMarkers() {
    const monasteryListDiv = document.getElementById('monasteryList');
    monasteryListDiv.innerHTML = ''; monasteryLayer.clearLayers(); attractionLayer.clearLayers();
    DATA.monasteries.forEach(m => {
        const name = m.name[currentLanguage] || m.name.en;
        const monasteryIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-pin" style="background-color:${m.color};"><div class="map-pin-icon">${m.icon}</div></div>`, iconSize: [30, 42], iconAnchor: [15, 42] });
        L.marker(m.coords, { icon: monasteryIcon }).addTo(monasteryLayer).bindTooltip(name);
        const card = document.createElement('div');
        card.className = 'monastery-card';
        card.innerHTML = `<div class="monastery-name" style="color:${m.color}">${m.icon} ${name}</div><div class="attractions-list"></div>`;
        const attractionsList = card.querySelector('.attractions-list');
        m.attractions.forEach(attr => {
            const attrName = attr.name[currentLanguage] || attr.name.en;
            const attractionIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="map-pin" style="background-color:${m.color};"><div class="map-pin-icon">${attr.icon}</div></div>`, iconSize: [30, 42], iconAnchor: [15, 42] });
            const marker = L.marker(attr.coords, { icon: attractionIcon, riseOnHover: true, zIndexOffset: 1000 }).addTo(attractionLayer).bindTooltip(attrName);
            attractionRegistry[attr.id] = { marker, monastery: m, attraction: attr };
            marker.on('click', async () => {
                openFarePopup(m, attr);
            });
            const item = document.createElement('div');
            item.className = 'attraction-item'; item.innerText = `${attr.icon} ${attrName}`;
            item.dataset.monasteryId = m.id; item.dataset.attractionId = attr.id;
            attractionsList.appendChild(item);
        });
        if (openMonasteries.has(m.id)) { attractionsList.style.display = 'block'; }
        card.addEventListener('click', (e) => {
            if (e.target.closest('.attraction-item')) return;
            const isVisible = attractionsList.style.display === 'block';
            attractionsList.style.display = isVisible ? 'none' : 'block';
            if (isVisible) { openMonasteries.delete(m.id); } else { openMonasteries.add(m.id); }
            if (!isVisible) map.flyTo(m.coords, 14);
        });
        monasteryListDiv.appendChild(card);
    });
}
document.getElementById('monasteryList').addEventListener('click', function(e) {
    const target = e.target.closest('.attraction-item');
    if (target) {
        const monastery = DATA.monasteries.find(m => m.id === target.dataset.monasteryId);
        const attraction = monastery.attractions.find(a => a.id === target.dataset.attractionId);
        if (monastery && attraction) {
            // Fly to the attraction marker and open fare popup
            const reg = attractionRegistry[attraction.id];
            if (reg && reg.marker) {
                map.flyTo(reg.marker.getLatLng(), 14);
            }
            openFarePopup(monastery, attraction);
        }
    }
});
document.getElementById('closeInfo').addEventListener('click', () => {
    document.getElementById('infoBox').classList.remove('visible');
    if (currentRouteLayer) map.removeLayer(currentRouteLayer);
});
// Initial Load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);
    setLanguage('en');
});
</script>
</body>
</html>

